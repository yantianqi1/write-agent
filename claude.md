# 对话式小说创作 Agent - 开发进度跟踪

## 项目概述

开发一个**以对话为中心**的智能小说创作系统。用户只需与 Agent 自然对话，即可完成从设定提取到正文生成的完整创作流程。

### 核心理念
- **用户只需聊天** - 不需要手动填写复杂的人设、世界观表单
- **自动提取设定** - Agent 从对话中自动识别并结构化角色、世界观、情节
- **边聊边创作** - 可以随时查看已生成内容，指定修改，继续创作
- **智能追问** - 当设定信息不足时，Agent 会主动询问关键信息

### 产品愿景
实现零门槛的 AI 协作小说创作：用户像和一个创作伙伴聊天一样，自然而然地完成一部高质量长篇小说。

### 典型使用流程
```
用户: 我想写个小说
Agent: 好的！什么类型的小说？
用户: 科幻，赛博朋克那种
Agent: 赛博朋克，很酷！主角是什么样的人？
用户: 一个黑客，叫Neo，想反抗公司
[Agent 自动提取设定到记忆系统]
Agent: 明白了，Neo是个想反抗公司的黑客。哪个公司？为什么反抗？
...（继续对话补全设定）
Agent: 设定差不多了，我帮你生成个大纲？
用户: 好
[生成大纲并展示 → 用户确认 → 开始创作]
用户: 继续写
[生成下一章]
用户: 第四章结尾不太好，改一下，要悬念一点
[定位并修改 → 展示修改前后对比]
```

---

## 系统架构

### 核心流程图
```
用户对话
    ↓
┌─────────────────────────────────────┐
│  对话意图识别模块                    │
│  (创作/修改/查询/设定)               │
└─────────────────────────────────────┘
    ↓
┌───────────────────────────────────────┐
│  设定提取模块 ←────────────────┐       │
│  - 从对话提取角色/世界观/情节   │       │
│  - 智能判断缺失信息             │       │
│  - 追问关键设定                 │       │
└─────────────────────────────────────┘ │
    ↓                                   │
    ↓                                   │
┌─────────────────────────────────────┐ │
│  记忆系统 (已完成)                   │ │
│  - 角色库                            │◄┘
│  - 世界观                            │
│  - 情节线                            │
│  - 近期上下文                        │
│  - 风格偏好                          │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│  创作决策引擎                        │
│  - 判断是否可以开始创作              │
│  - 选择生成策略                      │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│  大纲生成器                          │
│  (增量式，边聊边生成)                │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│  篇章细化 + 正文生成                 │
│  - 基于记忆保持一致性                │
│  - 支持增量生成                      │
│  - 支持局部修改                      │
└─────────────────────────────────────┘
    ↓
已生成内容展示 → 用户反馈 → 回到对话
```

---

## 开发阶段和里程碑

### 阶段 0：基础架构 ✅ 已完成
- [x] 项目初始化
- [x] 目录结构创建
- [x] 记忆系统框架设计 (HierarchicalMemory)
- [x] 基础依赖配置
- [x] 素材收集模块基础 (可改造为对话式)
- [x] 基础测试框架

**完成度：** 100%
**完成日期：** 2026-02-05

### 阶段 1：记忆系统 ✅ 已完成
- [x] 记忆系统基础接口 (src/memory/base.py)
- [x] 分层记忆系统实现 (src/memory/hierarchical.py)
- [x] 向量存储抽象接口 (src/memory/vector.py)
- [x] Chroma 向量存储实现
- [x] Mock 向量存储实现
- [x] 向量检索集成
- [x] 单元测试
- [x] 使用示例

**完成度：** 100%
**完成日期：** 2026-02-05

### 阶段 2：对话式设定提取 🔥 当前重点 - 0%
- [ ] 对话意图识别器
  - [ ] 意图分类（创作/修改/查询/设定/闲聊）
  - [ ] 意图参数提取
  - [ ] 对话状态机
- [ ] 设定提取器
  - [ ] 角色设定提取（姓名、性格、背景、关系）
  - [ ] 世界观提取（类型、规则、背景）
  - [ ] 情节线提取（起因、冲突、高潮、结局）
  - [ ] 风格偏好提取（文风、节奏、视角）
- [ ] 智能追问系统
  - [ ] 最小必要信息判断
  - [ ] 缺失信息检测
  - [ ] 追问策略（何时问、问什么、怎么问）
- [ ] 设定冲突检测
  - [ ] 角色设定矛盾检测
  - [ ] 世界观逻辑冲突检测
  - [ ] 情节线矛盾检测
- [ ] 记忆系统集成
  - [ ] 对话历史存储
  - [ ] 设定信息结构化存储
  - [ ] 增量更新机制
- [ ] 单元测试
- [ ] 使用示例

**完成度：** 0%
**预计开始：** 2026-02-05

### 阶段 3：对话式创作引擎 ⏳ 待开始 - 0%
- [ ] 创作决策引擎
  - [ ] 设定完成度判断
  - [ ] 创作时机选择
  - [ ] 生成策略选择
- [ ] 增量式大纲生成
  - [ ] 边聊边生成大纲
  - [ ] 大纲动态调整
  - [ ] 大纲与对话同步
- [ ] 篇章细化模块
  - [ ] 章节切分算法
  - [ ] 情节节点展开
  - [ ] 伏笔埋设机制
- [ ] 增量正文生成
  - [ ] 基于上下文的续写
  - [ ] 局部重写（保持连贯）
  - [ ] 扩写和缩写
- [ ] 一致性保证
  - [ ] 角色行为一致性
  - [ ] 世界观规则一致性
  - [ ] 情节逻辑一致性
- [ ] 单元测试
- [ ] 使用示例

**完成度：** 0%

### 阶段 4：用户交互界面 ⏳ 待开始 - 0%
- [ ] 对话界面
  - [ ] 聊天气泡展示
  - [ ] 对话历史滚动
  - [ ] 输入和发送
- [ ] 创作内容展示
  - [ ] 章节列表
  - [ ] 正文阅读器
  - [ ] 修改高亮
- [ ] 修改交互
  - [ ] 选择要修改的段落
  - [ ] 查看修改前后对比
  - [ ] 确认/撤销修改
- [ ] 进度指示
  - [ ] 设定完成度
  - [] 创作进度
  - [ ] 当前章节

**完成度：** 0%

### 阶段 5：集成与优化 ⏳ 待开始 - 0%
- [ ] 端到端流程整合
- [ ] 性能优化
- [ ] 错误处理
- [ ] 用户测试
- [ ] 文档完善

---

## 已完成功能清单

### 基础设施
- ✅ 项目目录结构创建
- ✅ Git 仓库初始化
- ✅ 基础 Python 包结构
- ✅ 项目依赖配置 (requirements.txt)
- ✅ 应用配置文件 (config.yaml)

### 记忆系统 (100%)
- ✅ 记忆系统抽象接口 (src/memory/base.py) - 262 行
  - `MemoryStore` 抽象基类
  - `MemoryLevel` 记忆层级枚举
  - `MemoryItem` 记忆项数据类
- ✅ 分层记忆系统实现 (src/memory/hierarchical.py) - 348 行
  - `HierarchicalMemory` 分层记忆管理
  - 跨层级检索
  - 上下文注入
  - 记忆持久化
- ✅ 向量存储系统 (src/memory/) - 339 行
  - `VectorStore` 抽象接口
  - `MockVectorStore` 模拟实现
  - `ChromaVectorStore` Chroma 实现
  - 向量检索集成
- ✅ 单元测试 (3 个测试文件，80+ 测试用例)
- ✅ 使用示例 (memory_usage.py - 542 行)

**功能特性：**
- 支持 5 种记忆层级（全局、角色、情节、上下文、风格）
- 向量语义检索
- 时间衰减机制
- 相关性评分

### 素材收集系统 (100%)
- ✅ 素材收集模块抽象接口 (src/story/material_collector.py) - 282 行
  - `Material` 素材数据类（内容哈希、去重、可信度）
  - `MaterialSource` 来源枚举
  - `MaterialCategory` 分类枚举
  - `MaterialCollector` 抽象基类
  - `MaterialDeduplicator` 去重器
  - `CredibilityEvaluator` 可信度评估器
  - `CompositeMaterialCollector` 复合收集器
- ✅ 本地知识库收集器 (src/story/local_knowledge_collector.py) - 207 行
- ✅ 联网搜索收集器 (src/story/web_search_collector.py) - 262 行
- ✅ 单元测试 (test_material_collector.py - 602 行)
- ✅ 使用示例 (material_collector_usage.py - 312 行)

**功能特性：**
- 多来源素材收集（本地、网络、用户、历史）
- 智能去重（基于内容哈希）
- 可信度评估（多因素综合评分）
- 灵活过滤和排序

**注意：** 素材收集系统可以改造为从对话中收集设定信息

---

## 当前任务

### 🔥 正在进行：对话式设定提取模块

**任务描述：**
实现从用户对话中自动提取结构化设定的核心模块，这是整个对话式创作系统的基础。

**子任务：**
1. **设计设定数据结构**
   - CharacterProfile（角色档案）
   - WorldSetting（世界观设定）
   - PlotElement（情节元素）
   - StylePreference（风格偏好）

2. **实现对话意图识别器**
   - 意图分类
   - 参数提取

3. **实现设定提取器**
   - 角色提取逻辑
   - 世界观提取逻辑
   - 情节线提取逻辑

4. **实现智能追问系统**
   - 最小必要信息判断
   - 追问生成策略

5. **集成记忆系统**
   - 对话历史存储
   - 设定信息结构化存储

---

## 待办事项（按优先级排序）

### 🔴 最高优先级 - 对话式设定提取

1. **设定数据结构设计** - 数据模型
   - [ ] CharacterProfile 类
   - [ ] WorldSetting 类
   - [ ] PlotElement 类
   - [ ] StylePreference 类
   - [ ] ExtractedSettings 集合类
   - [ ] MissingInfo 缺失信息类

2. **对话意图识别器** - 理解用户想做什么
   - [ ] IntentType 枚举（CREATING, MODIFYING, QUERYING, SETTING, CHATTING）
   - [ ] IntentRecognizer 类
   - [ ] 意图分类逻辑（基于规则或 LLM）
   - [ ] 参数提取逻辑

3. **设定提取器** - 从对话提取结构化信息
   - [ ] SettingExtractor 类
   - [ ] 角色提取（姓名、性格、背景、关系、能力）
   - [ ] 世界观提取（类型、时代、规则、背景）
   - [ ] 情节线提取（起因、冲突、发展、高潮、结局）
   - [ ] 风格偏好提取（文风、视角、节奏、语言）

4. **智能追问系统** - 补全缺失信息
   - [ ] SettingCompletenessChecker 类
   - [ ] 最小必要信息定义
   - [ ] 缺失信息检测
   - [ ] 追问生成器（QuestionGenerator）
   - [ ] 追问策略（优先级、时机）

5. **设定冲突检测** - 避免矛盾
   - [ ] ConflictDetector 类
   - [ ] 角色设定冲突检测
   - [ ] 世界观逻辑冲突检测
   - [ ] 情节线矛盾检测
   - [ ] 冲突提示生成

6. **对话历史管理** - 记录和追溯
   - [ ] ConversationHistory 类
   - [ ] 消息存储（用户消息、AI 响应）
   - [ ] 设定变更追踪
   - [ ] 历史查询接口

7. **记忆系统集成** - 持久化设定
   - [ ] 对话历史 → 记忆系统映射
   - [ ] 设定信息 → 角色库/世界观库映射
   - [ ] 增量更新机制

8. **单元测试**
   - [ ] 设定提取器测试
   - [ ] 意图识别器测试
   - [ ] 追问系统测试
   - [ ] 冲突检测测试
   - [ ] 记忆系统集成测试

9. **使用示例**
   - [ ] 完整的对话式设定提取流程
   - [ ] 各种设定类型的提取示例
   - [ ] 追问系统演示

### 🟠 高优先级 - 创作引擎

10. **创作决策引擎** - 决定何时创作
    - [ ] CreationDecisionEngine 类
    - [ ] 设定完成度评估
    - [ ] 创作时机判断
    - [ ] 生成策略选择

11. **增量式大纲生成** - 边聊边生成
    - [ ] IncrementalOutlineGenerator 类
    - [ ] 基于当前设定的大纲生成
    - [ ] 大纲动态调整
    - [ ] 用户反馈集成

12. **篇章细化模块**
    - [ ] 章节切分算法
    - [ ] 情节节点展开
    - [ ] 伏笔埋设机制

13. **增量正文生成**
    - [ ] IncrementalContentGenerator 类
    - [ ] 基于上下文的续写
    - [ ] 局部重写（保持连贯）
    - [ ] 扩写和缩写

### 🟡 中优先级 - 用户界面

14. **对话界面**
    - [ ] 聊天气泡组件
    - [ ] 对话历史展示
    - [ ] 输入和发送

15. **创作内容展示**
    - [ ] 章节列表
    - [ ] 正文阅读器
    - [ ] 修改高亮

16. **修改交互**
    - [ ] 段落选择
    - [ ] 修改前后对比
    - [ ] 确认/撤销

### 🟢 低优先级 - 优化和增强

17. **向量数据库实际部署**
18. **性能优化**
19. **API 接口开发**
20. **Web 界面开发**
21. **多风格支持**

---

## 技术决策记录

### 2026-02-05 - 产品方向调整

**决策 6：转向对话式创作系统**
- 原方案：用户填写表单式设定 → 生成大纲 → 创作
- 新方案：用户与 Agent 聊天 → 自动提取设定 → 边聊边创作
- 理由：
  - 降低用户门槛（不需要手动填写复杂设定）
  - 更自然的交互方式（像和创作伙伴聊天）
  - 支持增量创作（可以边写边调整设定）
  - 更灵活（随时可以修改、查询、继续）
- 影响：
  - 增加：对话意图识别、设定提取、智能追问模块
  - 调整：大纲生成改为增量式
  - 保留：记忆系统、素材收集（改造为对话式）

### 2026-02-05 - 向量数据库选择

**决策 1：向量数据库选择**
- 选项：Pinecone, Milvus, Chroma, Weaviate
- 选择：Chroma（暂定）
- 理由：
  - 开源免费
  - 本地部署简单
  - Python API 友好
  - 支持持久化存储
- 状态：✅ 已实现 ChromaVectorStore 和 MockVectorStore

### 2026-02-05 - 记忆系统架构

**决策 2：记忆系统架构**
- 采用分层记忆系统（Hierarchical Memory）
- 层级：全局记忆、角色记忆库、情节记忆、近期上下文、风格记忆
- 理由：平衡性能与一致性需求
- 状态：✅ 已实现并测试通过

### 2026-02-05 - 素材收集模块

**决策 3：素材收集模块架构**
- 采用抽象基类设计，支持多来源收集
- 收集器类型：本地知识库、联网搜索、用户输入、历史作品
- **新方向：** 对话式设定收集
  - 从对话中提取角色、世界观、情节信息
  - 智能追问补全缺失信息
  - 自动检测设定冲突
- 状态：✅ 基础架构已完成，需要改造为对话式

### 2026-02-05 - 开发框架

**决策 4：开发语言和框架**
- 语言：Python（AI 生态成熟）
- 框架：FastAPI（API 服务，待实现）
- 前端：React（可选，后期考虑）
- LLM 集成：支持 OpenAI Claude API
- 状态：初步决定

### 2026-02-05 - 模块组织

**决策 5：模块组织结构**
- 所有核心功能放在 src/ 目录
- Mock 实现与正式实现在同一文件中
- 状态：已实施

---

## 代码统计

### 文件统计
- **总文件数：** 32 个
- **Python 源代码：** 15 个
- **测试文件：** 5 个
- **示例文件：** 2 个
- **配置/文档：** 10+ 个

### 代码行数
| 模块 | 文件数 | 行数 | 状态 |
|------|--------|------|------|
| 记忆系统 | 6 | ~1,355 | ✅ 100% |
| 素材收集 | 3 | ~751 | ✅ 100% |
| 设定提取 | 0 | 0 | 🔥 待开发 |
| 对话管理 | 0 | 0 | 🔥 待开发 |
| 测试代码 | 5 | ~1,432 | ✅ 完成 |
| 示例代码 | 2 | ~854 | ✅ 完成 |
| **总计** | **22** | **~4,392** | |

---

## 项目状态总结

### 整体完成度：25%

```
阶段进度：
基础架构    ████████████████████████ 100% ████████████████████████
记忆系统    ████████████████████████ 100% ████████████████████████
设定提取    ░░░░░░░░░░░░░░░░░░░░░░░░░░   0% ░░░░░░░░░░░░░░░░░░░░░░░░░
创作引擎    ░░░░░░░░░░░░░░░░░░░░░░░░░░   0% ░░░░░░░░░░░░░░░░░░░░░░░░░
用户界面    ░░░░░░░░░░░░░░░░░░░░░░░░░░   0% ░░░░░░░░░░░░░░░░░░░░░░░░░
```

### ✅ 已完成模块
1. **记忆系统（100%）** - 完全可用
   - 分层记忆架构
   - 向量语义检索
   - 完整测试和示例

2. **素材收集系统（100%）** - 可改造
   - 多来源收集
   - 去重和评估
   - 完整测试和示例

### 🔥 当前重点模块
3. **对话式设定提取（0%）** - 正在启动
   - 设定数据结构设计
   - 对话意图识别
   - 智能追问系统
   - 设定冲突检测

### ⏳ 待开发模块
4. **对话式创作引擎（0%）**
5. **用户交互界面（0%）**

---

## 下一步计划

### 立即执行（本周）
1. **设计设定数据结构**
   - CharacterProfile（角色档案）
   - WorldSetting（世界观设定）
   - PlotElement（情节元素）
   - ExtractedSettings（设定集合）

2. **实现对话意图识别器原型**
   - 基础的意图分类
   - 简单的参数提取

3. **实现设定提取器原型**
   - 角色信息提取
   - 世界观信息提取
   - 集成到记忆系统

### 短期目标（2周内）
4. **实现智能追问系统**
   - 最小必要信息判断
   - 追问生成策略

5. **实现设定冲突检测**
   - 角色设定冲突
   - 世界观逻辑冲突

6. **编写完整的使用示例**
   - 从零开始的对话式设定提取
   - 各种设定类型演示

### 中期目标（1个月内）
7. **增量式大纲生成**
8. **创作决策引擎**
9. **增量正文生成**

### 长期目标（3个月内）
10. **用户交互界面**
11. **端到端集成**
12. **性能优化和测试**

---

## 最后更新

- **日期：** 2026-02-05 18:00 UTC
- **更新人：** Claude Code
- **更新内容：**
  - 🎯 **重大产品方向调整**
  - 从"表单式设定"转向"对话式设定提取"
  - 更新项目概述，强调对话式交互
  - 新增系统架构图，展示对话驱动流程
  - 重组开发阶段，增加"对话式设定提取"阶段
  - 更新待办事项，设定提取成为最高优先级
  - 更新技术决策记录，记录产品方向调整
  - 调整项目完成度（因新增模块，从40%降至25%）

### 核心变化
1. **新增模块：**
   - 对话意图识别器
   - 设定提取器
   - 智能追问系统
   - 设定冲突检测
   - 对话历史管理

2. **调整模块：**
   - 大纲生成：改为增量式（边聊边生成）
   - 素材收集：改造为从对话中收集设定
   - 创作引擎：支持对话驱动的增量创作

3. **保留模块：**
   - 记忆系统（完全可用，不需要改动）
   - 基础架构（项目结构、测试框架）

### 项目状态
**已完成：** 记忆系统（100%）、素材收集（100%）
**进行中：** 对话式设定提取（0% - 即将开始）
**待开发：** 创作引擎、用户界面

---

**项目健康度：** ⭐⭐⭐⭐⭐
- 方向清晰
- 基础扎实
- 用户体验优先
- 技术可行性强
