# é¡¹ç›®æ€§èƒ½ä¸ç”¨æˆ·ä½“éªŒå‡çº§è®¡åˆ’

> åˆ†ææ—¥æœŸ: 2026-02-06
> é¡¹ç›®: AIå°è¯´åˆ›ä½œåŠ©æ‰‹ (Write-Agent)

---

## ğŸ“Š å½“å‰æ¶æ„æ¦‚è¿°

### æŠ€æœ¯æ ˆ
- **åç«¯**: FastAPI + PostgreSQL + Redis + SQLAlchemy 2.0 (å¼‚æ­¥)
- **å‰ç«¯**: Next.js 16.1.6 + TypeScript + Zustand + Tailwind CSS v4
- **éƒ¨ç½²**: Docker Compose + Nginx åå‘ä»£ç†

---

## ğŸ”´ é«˜ä¼˜å…ˆçº§é—®é¢˜

### 1. å®‰å…¨æ¼æ´

#### 1.1 ç¼ºå°‘èº«ä»½éªŒè¯ä¸æˆæƒ
**ä½ç½®**: `src/api/main.py`
```python
# å½“å‰: æ‰€æœ‰APIç«¯ç‚¹å…¬å¼€è®¿é—®
# é£é™©: ä»»ä½•äººå¯è®¿é—®/ä¿®æ”¹ç”¨æˆ·æ•°æ®
```
**æ”¹è¿›æ–¹æ¡ˆ**:
- å®ç° JWT èº«ä»½éªŒè¯
- æ·»åŠ åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ (RBAC)
- ä¿æŠ¤ç®¡ç†ç«¯ç‚¹ `/admin/*`

#### 1.2 ç¼ºå°‘è¾“å…¥éªŒè¯
**ä½ç½®**: `src/api/routers/chat.py:115-123`
```python
# å½“å‰: æ²¡æœ‰æ¶ˆæ¯å†…å®¹é•¿åº¦éªŒè¯
# é£é™©: æ¶æ„ç”¨æˆ·å‘é€è¶…å¤§æ¶ˆæ¯å¯¼è‡´å†…å­˜æº¢å‡º
```
**æ”¹è¿›æ–¹æ¡ˆ**:
- æ·»åŠ æ¶ˆæ¯é•¿åº¦é™åˆ¶ (å»ºè®®: 1-10000 å­—ç¬¦)
- å®ç°å†…å®¹è¿‡æ»¤å’Œæ•æ„Ÿè¯æ£€æµ‹
- æ·»åŠ é€Ÿç‡é™åˆ¶ (Rate Limiting)

#### 1.3 XSS æ¼æ´é£é™©
**ä½ç½®**: `frontend/src/components/chat/chat-workspace.tsx:69-71`
```typescript
// å½“å‰: ç›´æ¥æ¸²æŸ“ç”¨æˆ·æ¶ˆæ¯å†…å®¹
// é£é™©: æ¶æ„è„šæœ¬æ³¨å…¥
```
**æ”¹è¿›æ–¹æ¡ˆ**:
- ä½¿ç”¨ DOMPurify æ¸…æ´— HTML å†…å®¹
- å®ç° CSP (Content Security Policy) å¤´
- æ·»åŠ å®‰å…¨ç›¸å…³ HTTP å¤´

#### 1.4 ç¼ºå°‘é€Ÿç‡é™åˆ¶
**ä½ç½®**: `src/api/main.py`
**æ”¹è¿›æ–¹æ¡ˆ**:
```python
# æ·»åŠ  slowapi é™æµ
from slowapi import Limiter
limiter = Limiter(key_func=get_remote_address)

@limiter.limit("10/minute")
@app.post("/api/v1/chat/")
async def send_message(...):
    ...
```

---

## ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ - åç«¯æ€§èƒ½ä¼˜åŒ–

### 2.1 æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ– (N+1 é—®é¢˜)

#### é—®é¢˜ 1: é‡å¤æŸ¥è¯¢ä¼˜åŒ–
**ä½ç½®**: `src/api/database/crud.py:244-268`
```python
# å½“å‰: ä¸¤æ¬¡ç‹¬ç«‹æŸ¥è¯¢
async def update_project_word_count(db, project_id):
    word_count = await count_words(db, project_id)  # æŸ¥è¯¢1
    chapter_count = await count_chapters(db, project_id)  # æŸ¥è¯¢2
```
**æ”¹è¿›æ–¹æ¡ˆ**:
```python
# åˆå¹¶ä¸ºå•æ¬¡æŸ¥è¯¢
async def update_project_word_count(db, project_id):
    result = await db.execute(
        select(
            func.sum(Chapter.word_count).label("words"),
            func.count(Chapter.id).label("chapters")
        ).where(Chapter.project_id == project_id)
    )
```

#### é—®é¢˜ 2: è¿æ¥æ± é…ç½®ä¸è¶³
**ä½ç½®**: `config/config.yaml`
```yaml
# å½“å‰é…ç½®
pool_size: 5
max_overflow: 10
```
**å»ºè®®é…ç½®**:
```yaml
pool_size: 20          # åŸºäºå¹¶å‘ç”¨æˆ·è°ƒæ•´
max_overflow: 40       # å³°å€¼æµé‡æ”¯æŒ
pool_timeout: 30       # è¿æ¥è¶…æ—¶
pool_recycle: 3600     # è¿æ¥å›æ”¶æ—¶é—´
```

### 2.2 LLM è°ƒç”¨ä¼˜åŒ–

#### ç¼ºå°‘è¶…æ—¶æ§åˆ¶
**ä½ç½®**: `src/api/routers/chat.py:138-148`
```python
# å½“å‰: æ— è¶…æ—¶è®¾ç½®
# é£é™©: LLM å“åº”æ—¶é—´è¿‡é•¿å¯¼è‡´è¯·æ±‚é˜»å¡
```
**æ”¹è¿›æ–¹æ¡ˆ**:
```python
# æ·»åŠ è¶…æ—¶å’Œç†”æ–­æœºåˆ¶
from asyncio import timeout

async with timeout(30):
    response = await llm_client.generate(prompt)
```

#### ç¼ºå°‘é‡è¯•ç­–ç•¥
**æ”¹è¿›æ–¹æ¡ˆ**:
```python
# å®ç°æŒ‡æ•°é€€é¿é‡è¯•
from tenacity import retry, stop_after_attempt, wait_exponential

@retry(stop=stop_after_attempt(3), wait=wait_exponential(multiplier=1, min=4, max=10))
async def call_llm(prompt):
    ...
```

### 2.3 ç¼“å­˜ä¼˜åŒ–

#### å½“å‰ç¼“å­˜é—®é¢˜
**ä½ç½®**: `src/api/cache/`
- ä¼šè¯å†å²ç¼“å­˜æ— è‡ªåŠ¨æ¸…ç†æœºåˆ¶
- ç¼“å­˜å‡»ç©¿é£é™©ï¼ˆçƒ­é—¨æ•°æ®åŒæ—¶å¤±æ•ˆï¼‰

**æ”¹è¿›æ–¹æ¡ˆ**:
```python
# æ·»åŠ ç¼“å­˜è‡ªåŠ¨æ¸…ç†
import asyncio

async def cleanup_expired_sessions():
    while True:
        await asyncio.sleep(300)  # æ¯5åˆ†é’Ÿæ¸…ç†
        now = time.time()
        for key, (_, timestamp) in list(cache.items()):
            if now - timestamp > TTL:
                del cache[key]
```

---

## ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ - å‰ç«¯æ€§èƒ½ä¼˜åŒ–

### 3.1 æ¸²æŸ“æ€§èƒ½ä¼˜åŒ–

#### é—®é¢˜: ä¸å¿…è¦çš„é‡æ¸²æŸ“
**ä½ç½®**: `frontend/src/components/chat/chat-workspace.tsx:135-137`
```typescript
// å½“å‰: æ¯æ¬¡æ¶ˆæ¯å˜åŒ–éƒ½è§¦å‘å®Œæ•´é‡æ¸²æŸ“
<div className="messages">
  {messages.map(msg => <ChatMessage key={msg.id} message={msg} />)}
</div>
```
**æ”¹è¿›æ–¹æ¡ˆ**:
```typescript
// 1. ä½¿ç”¨ React.memo ä¼˜åŒ–æ¶ˆæ¯ç»„ä»¶
const ChatMessage = React.memo(({ message }) => {
  return <div>...</div>
}, (prev, next) => prev.message.id === next.message.id)

// 2. å®ç°è™šæ‹Ÿæ»šåŠ¨
import { useVirtualizer } from '@tanstack/react-virtual'

const rowVirtualizer = useVirtualizer({
  count: messages.length,
  getScrollElement: () => parentRef.current,
  estimateSize: () => 100,
  overscan: 5
})
```

#### é—®é¢˜: çŠ¶æ€ç®¡ç†æ•ˆç‡
**ä½ç½®**: `frontend/src/store/sessionStore.ts:192-196`
**æ”¹è¿›æ–¹æ¡ˆ**:
```typescript
// æ·»åŠ é€‰æ‹©å™¨è®°å¿†åŒ–
import { shallow } from 'zustand/shallow'

// ä½¿ç”¨é€‰æ‹©å™¨é¿å…ä¸å¿…è¦çš„è®¢é˜…
const messages = useSessionStore(
  state => state.messages[sessionId],
  shallow
)
```

### 3.2 API è°ƒç”¨ä¼˜åŒ–

#### é—®é¢˜: ç¼ºå°‘è¯·æ±‚å»é‡
**ä½ç½®**: `frontend/src/lib/api.ts:274-286`
```typescript
// å½“å‰: ç›¸åŒè¯·æ±‚å¯èƒ½å¹¶å‘å‘é€
```
**æ”¹è¿›æ–¹æ¡ˆ**:
```typescript
// å®ç°è¯·æ±‚å»é‡
const pendingRequests = new Map<string, Promise<any>>();

async function fetchWithDedup(key, fetcher) {
  if (pendingRequests.has(key)) {
    return pendingRequests.get(key);
  }
  const promise = fetcher().finally(() => pendingRequests.delete(key));
  pendingRequests.set(key, promise);
  return promise;
}
```

#### é—®é¢˜: ç¼ºå°‘è¯·æ±‚å–æ¶ˆ
**æ”¹è¿›æ–¹æ¡ˆ**:
```typescript
// ä½¿ç”¨ AbortController
const controller = new AbortController();

fetch('/api/chat', {
  signal: controller.signal
});

// å–æ¶ˆæ¶ˆè¯·æ±‚
controller.abort();
```

### 3.3 ä»£ç åˆ†å‰²ä¸åŒ…ä½“ç§¯ä¼˜åŒ–

**å½“å‰é—®é¢˜**:
- é‡è¯•é€»è¾‘æ‰“åŒ…åœ¨ä¸» bundle ä¸­
- æœªä½¿ç”¨åŠ¨æ€å¯¼å…¥

**æ”¹è¿›æ–¹æ¡ˆ**:
```typescript
// åŠ¨æ€å¯¼å…¥å‡å°‘åˆå§‹åŒ…ä½“ç§¯
const ChatWorkspace = dynamic(() =>
  import('@/components/chat/chat-workspace').then(m => m.ChatWorkspace),
{
  loading: () => <Skeleton />,
  ssr: false
}
)
```

---

## ğŸŸ¢ ä½ä¼˜å…ˆçº§ - ç”¨æˆ·ä½“éªŒæ”¹è¿›

### 4.1 åŠ è½½çŠ¶æ€ä¼˜åŒ–

#### ç¼ºå°‘éª¨æ¶å±
**ä½ç½®**: `frontend/src/app/chat/page.tsx:35-48`
```typescript
// å½“å‰: sendMessage æ— åŠ è½½åé¦ˆ
```
**æ”¹è¿›æ–¹æ¡ˆ**:
```typescript
// æ·»åŠ æ‰“å­—æŒ‡ç¤ºå™¨
{isGenerating && <TypingIndicator />}

// æ·»åŠ æµå¼è¿›åº¦åé¦ˆ
<ProgressStream value={progress} />
```

#### ç¼ºå°‘æ“ä½œåé¦ˆ
**æ”¹è¿›æ–¹æ¡ˆ**:
```typescript
// æ·»åŠ  Toast é€šçŸ¥
import { toast } from '@/components/ui/toast';

toast.success('ç« èŠ‚ç”ŸæˆæˆåŠŸ');
toast.error('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œå·²é‡è¯•');
```

### 4.2 é”™è¯¯å¤„ç†æ”¹è¿›

#### é€šç”¨é”™è¯¯æ¶ˆæ¯
**ä½ç½®**: `frontend/src/lib/api.ts:154-167`
```typescript
// å½“å‰: é€šç”¨é”™è¯¯æç¤º
```
**æ”¹è¿›æ–¹æ¡ˆ**:
```typescript
// æ ¹æ®é”™è¯¯ç±»å‹æä¾›å…·ä½“æŒ‡å¯¼
const errorMessages = {
  NetworkError: 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®',
  TimeoutError: 'è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•',
  RateLimitError: 'è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•',
  ValidationError: 'è¾“å…¥å†…å®¹æ ¼å¼ä¸æ­£ç¡®'
};
```

### 4.3 å¯è®¿é—®æ€§æ”¹è¿›

#### ç¼ºå°‘ ARIA æ ‡ç­¾
**ä½ç½®**: `frontend/src/components/chat/chat-workspace.tsx:188`
```typescript
// å½“å‰:
<button onClick={goBack}>è¿”å›</button>

// æ”¹è¿›:
<button
  onClick={goBack}
  aria-label="è¿”å›ä¼šè¯åˆ—è¡¨"
  role="button"
>
  è¿”å›
</button>
```

#### é”®ç›˜å¯¼èˆªå¢å¼º
```typescript
// æ·»åŠ å¿«æ·é”®æ”¯æŒ
useEffect(() => {
  const handleKeyDown = (e: KeyboardEvent) => {
    if (e.metaKey || e.ctrlKey) {
      switch(e.key) {
        case 'k': // Cmd/Ctrl+K æœç´¢
          e.preventDefault();
          focusSearch();
          break;
        case 'n': // Cmd/Ctrl+N æ–°å»º
          e.preventDefault();
          createNewProject();
          break;
      }
    }
  };
  window.addEventListener('keydown', handleKeyDown);
  return () => window.removeEventListener('keydown', handleKeyDown);
}, []);
```

### 4.4 å“åº”å¼è®¾è®¡æ”¹è¿›

#### å›ºå®šå°ºå¯¸é—®é¢˜
**ä½ç½®**: `frontend/src/components/chat/chat-workspace.tsx`
```css
/* å½“å‰: å›ºå®šé«˜åº¦ */
height: 100vh;

/* æ”¹è¿›: ä½¿ç”¨ dvh å•ä½æ”¯æŒç§»åŠ¨ç«¯ */
height: 100dvh;
height: -webkit-fill-available;
```

---

## ğŸ“‹ å‡çº§å®æ–½æ¸…å•

### Phase 1: å®‰å…¨åŠ å›º (1-2å‘¨)
- [ ] å®ç° JWT èº«ä»½éªŒè¯
- [ ] æ·»åŠ é€Ÿç‡é™åˆ¶ä¸­é—´ä»¶
- [ ] å®ç°è¾“å…¥éªŒè¯å’Œå†…å®¹è¿‡æ»¤
- [ ] æ·»åŠ  XSS é˜²æŠ¤
- [ ] é…ç½®å®‰å…¨ HTTP å¤´

### Phase 2: æ€§èƒ½ä¼˜åŒ– (2-3å‘¨)
- [ ] æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
- [ ] è¿æ¥æ± é…ç½®è°ƒæ•´
- [ ] LLM è°ƒç”¨è¶…æ—¶å’Œé‡è¯•
- [ ] å‰ç«¯ç»„ä»¶ memo ä¼˜åŒ–
- [ ] å®ç°è™šæ‹Ÿæ»šåŠ¨
- [ ] API è¯·æ±‚å»é‡å’Œå–æ¶ˆ

### Phase 3: ç”¨æˆ·ä½“éªŒæå‡ (1-2å‘¨)
- [ ] æ·»åŠ åŠ è½½éª¨æ¶å±
- [ ] å®ç°æ“ä½œåé¦ˆ (Toast)
- [ ] æ”¹è¿›é”™è¯¯å¤„ç†
- [ ] å¯è®¿é—®æ€§å¢å¼º
- [ ] å“åº”å¼è®¾è®¡ä¼˜åŒ–

### Phase 4: ç›‘æ§ä¸å¯è§‚æµ‹æ€§ (1å‘¨)
- [ ] æ·»åŠ æ€§èƒ½ç›‘æ§ (APM)
- [ ] å®ç°é”™è¯¯è¿½è¸ª (Sentry)
- [ ] é…ç½®æ—¥å¿—èšåˆ
- [ ] æ·»åŠ ç”¨æˆ·åˆ†æ

---

## ğŸ“ˆ é¢„æœŸæ”¶ç›Š

| æŒ‡æ ‡ | å½“å‰ | ç›®æ ‡ | æ”¹è¿› |
|------|------|------|------|
| API å¹³å‡å“åº”æ—¶é—´ | ~800ms | <300ms | 62% â†“ |
| å‰ç«¯é¦–æ¬¡æ¸²æŸ“ (FCP) | ~2.5s | <1.5s | 40% â†“ |
| å†…å­˜å ç”¨ (å³°å€¼) | ~512MB | <256MB | 50% â†“ |
| å¹¶å‘ç”¨æˆ·æ”¯æŒ | ~20 | >100 | 5x â†‘ |
| å®‰å…¨æ¼æ´æ•°é‡ | 4+ | 0 | 100% |

---

## ğŸ› ï¸ æŠ€æœ¯å€ºåŠ¡è¿½è¸ª

| æ–‡ä»¶ | å€ºåŠ¡ç±»å‹ | ä¼˜å…ˆçº§ | é¢„ä¼°å·¥æ—¶ |
|------|----------|--------|----------|
| `src/api/main.py` | ç¼ºå°‘è®¤è¯ | P0 | 8h |
| `src/api/routers/chat.py` | è¾“å…¥éªŒè¯ | P0 | 4h |
| `frontend/src/components/chat/chat-workspace.tsx` | XSS é£é™© | P0 | 2h |
| `src/api/database/crud.py` | N+1 æŸ¥è¯¢ | P1 | 6h |
| `frontend/src/lib/api.ts` | è¯·æ±‚å»é‡ | P1 | 4h |
| `frontend/src/store/sessionStore.ts` | çŠ¶æ€ä¼˜åŒ– | P1 | 4h |
| `config/config.yaml` | è¿æ¥æ± é…ç½® | P2 | 1h |

---

> æœ€åæ›´æ–°: 2026-02-06
> ç»´æŠ¤è€…: å¼€å‘å›¢é˜Ÿ
